<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-1 fw-bold text-dark">
                <i class="fas fa-boxes text-primary me-2"></i>
                Gestión de Artículos
            </h4>
            <p class="text-muted small mb-0">Administra el catálogo de artículos del sistema</p>
        </div>
    </div>

    <!-- Buscador y botón nuevo -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-white">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control" placeholder="Buscar por nombre, código o referencia..."
                    [(ngModel)]="searchTerm" (input)="onSearch()">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" (click)="abrirFormularioNuevo()" [disabled]="!canWrite">
                <i class="fas fa-plus me-2"></i>
                Nuevo Artículo
            </button>
        </div>
    </div>

    <!-- Tabla -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div *ngIf="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="text-muted mt-2">Cargando artículos...</p>
                    </div>

                    <div *ngIf="!loading" class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">ID</th>
                                    <th class="border-0">Código</th>
                                    <th class="border-0">Nombre</th>
                                    <th class="border-0">Referencia</th>
                                    <th class="border-0">Unidad Base</th>
                                    <th class="border-0">Línea</th>
                                    <th class="border-0">Marca</th>
                                    <th class="border-0 text-center">Estado</th>
                                    <th class="border-0 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngIf="articulosFiltrados.length === 0">
                                    <td colspan="9" class="text-center text-muted py-5">
                                        <i class="fas fa-inbox fa-3x mb-3 d-block text-muted opacity-50"></i>
                                        <p class="mb-0">{{ searchTerm ? 'No se encontraron resultados' : 'No hay
                                            artículos registrados' }}</p>
                                    </td>
                                </tr>
                                <tr *ngFor="let a of unidadesPaginadas">
                                    <td class="align-middle text-muted small">{{ a.id_articulo }}</td>
                                    <td class="align-middle" data-label="Código">
                                        <span class="badge bg-light text-dark border">{{ a.codigo_alfanumerico || '-'
                                            }}</span>
                                    </td>
                                    <td class="align-middle fw-semibold" data-label="Nombre">{{ a.nombre }}</td>
                                    <td class="align-middle text-muted small" data-label="Referencia">{{ a.referencia ||
                                        '-' }}</td>
                                    <td class="align-middle" data-label="Unidad">{{ a.unidad_medida?.nombre || '-' }}
                                    </td>
                                    <td class="align-middle" data-label="Línea">{{ a.linea?.nombre || '-' }}</td>
                                    <td class="align-middle" data-label="Marca">{{ a.marca?.nombre || '-' }}</td>
                                    <td class="align-middle text-center" data-label="Estado">
                                        <span *ngIf="a.estado" class="badge bg-success">Activo</span>
                                        <span *ngIf="!a.estado" class="badge bg-danger">Inactivo</span>
                                    </td>
                                    <td class="align-middle text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" (click)="abrirFormularioEditar(a)"
                                                [disabled]="!canWrite" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" (click)="eliminar(a)"
                                                [disabled]="!canDelete" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    <div *ngIf="!loading && articulosFiltrados.length > 0" class="card-footer bg-white border-top">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <small class="text-muted">Página {{ currentPage }} de {{ totalPages }}</small>
                            </div>
                            <div class="col-md-6">
                                <nav aria-label="Paginación">
                                    <ul class="pagination pagination-sm justify-content-md-end mb-0">
                                        <li class="page-item" [class.disabled]="currentPage === 1">
                                            <a class="page-link" (click)="cambiarPagina(currentPage - 1)"
                                                href="javascript:void(0)"><i class="fas fa-chevron-left"></i></a>
                                        </li>
                                        <li class="page-item" *ngFor="let p of pages"
                                            [class.active]="p === currentPage">
                                            <a class="page-link" (click)="cambiarPagina(p)" href="javascript:void(0)">{{
                                                p }}</a>
                                        </li>
                                        <li class="page-item" [class.disabled]="currentPage === totalPages">
                                            <a class="page-link" (click)="cambiarPagina(currentPage + 1)"
                                                href="javascript:void(0)"><i class="fas fa-chevron-right"></i></a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de formulario -->
<div class="modal" [class.show]="showForm" [style.display]="showForm ? 'block' : 'none'" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-box me-2"></i>
                    {{ isEditing ? 'Editar Artículo' : 'Nuevo Artículo' }}
                </h5>
                <button type="button" class="btn-close" (click)="cerrarFormulario()"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <!-- Columna Izquierda -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" [(ngModel)]="formData.nombre" name="nombre"
                                    placeholder="Nombre del artículo" maxlength="250" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Código Alfanumérico</label>
                                <input type="text" class="form-control" [(ngModel)]="formData.codigo_alfanumerico"
                                    name="codigo_alfanumerico" placeholder="Ej: ART-001" maxlength="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Referencia</label>
                                <input type="text" class="form-control" [(ngModel)]="formData.referencia"
                                    name="referencia" placeholder="Referencia interna" maxlength="200">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Descripción</label>
                                <textarea class="form-control" [(ngModel)]="formData.descripcion" name="descripcion"
                                    rows="3" maxlength="500"></textarea>
                            </div>
                        </div>

                        <!-- Columna Derecha -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unidad de Medida Base <span
                                        class="text-danger">*</span></label>
                                <select class="form-select" [(ngModel)]="formData.id_unidad_medida"
                                    name="id_unidad_medida" required>
                                    <option [ngValue]="0" disabled>Seleccione una unidad</option>
                                    <option *ngFor="let u of unidadesMedida" [ngValue]="u.id_unidad_medida">
                                        {{ u.nombre }} ({{ u.simbolo }})
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Línea</label>
                                <select class="form-select" [(ngModel)]="formData.id_linea" name="id_linea">
                                    <option [ngValue]="undefined">Ninguna</option>
                                    <option *ngFor="let l of lineas" [ngValue]="l.id_linea">{{ l.nombre }}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de Artículo</label>
                                <select class="form-select" [(ngModel)]="formData.id_tipo_articulo"
                                    name="id_tipo_articulo">
                                    <option [ngValue]="undefined">Ninguno</option>
                                    <option *ngFor="let t of tiposArticulo" [ngValue]="t.id_tipo_articulo">{{ t.nombre
                                        }}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Marca</label>
                                <select class="form-select" [(ngModel)]="formData.id_marca" name="id_marca">
                                    <option [ngValue]="undefined">Ninguna</option>
                                    <option *ngFor="let m of marcas" [ngValue]="m.id_marca">{{ m.nombre }}</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Impuesto</label>
                                <select class="form-select" [(ngModel)]="formData.id_impuesto" name="id_impuesto">
                                    <option [ngValue]="undefined">Ninguno</option>
                                    <option *ngFor="let i of impuestos" [ngValue]="i.id_impuesto">{{ i.nombre }} ({{
                                        i.porcentaje }}%)</option>
                                </select>
                            </div>
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="estadoSwitch"
                                    [(ngModel)]="formData.estado" name="estado">
                                <label class="form-check-label" for="estadoSwitch">Activo</label>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Sección Códigos de Barra (Solo visible en edición) -->
                <div *ngIf="isEditing" class="mt-4 border-top pt-4">
                    <h6 class="mb-3 fw-bold text-primary">
                        <i class="fas fa-barcode me-2"></i>
                        Códigos de Barra
                    </h6>

                    <!-- Formulario agregar código -->
                    <div class="row g-2 align-items-end mb-3 bg-light p-3 rounded">
                        <div class="col-md-3">
                            <label class="form-label small">Código de Barra</label>
                            <input type="text" class="form-control form-control-sm"
                                [(ngModel)]="nuevoCodigo.codigo_barra" name="nuevo_codigo_barra"
                                placeholder="Escanear o escribir...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Tipo</label>
                            <select class="form-select form-select-sm" [(ngModel)]="nuevoCodigo.tipo_codigo_barra"
                                name="nuevo_tipo_codigo">
                                <option *ngFor="let t of tiposCodigoBarra" [ngValue]="t.valor">{{
                                    t.nombre }}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Unidad</label>
                            <select class="form-select form-select-sm" [(ngModel)]="nuevoCodigo.id_unidad_medida"
                                name="nuevo_id_unidad">
                                <option *ngFor="let u of unidadesMedida" [ngValue]="u.id_unidad_medida">
                                    {{ u.nombre }}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="principalSwitch"
                                    [(ngModel)]="nuevoCodigo.es_principal" name="nuevo_es_principal">
                                <label class="form-check-label small" for="principalSwitch">Principal</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success btn-sm w-100" (click)="agregarCodigo()">
                                <i class="fas fa-plus me-1"></i> Agregar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de códigos -->
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Código</th>
                                    <th>Tipo</th>
                                    <th>Vista Previa</th>
                                    <th>Unidad</th>
                                    <th class="text-center">Principal</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngIf="codigosBarra.length === 0">
                                    <td colspan="6" class="text-center text-muted small py-2">No hay
                                        códigos registrados
                                    </td>
                                </tr>
                                <tr *ngFor="let cb of codigosBarra">
                                    <td>{{ cb.codigo_barra }}</td>
                                    <td><span class="badge bg-secondary">{{ cb.tipo_codigo_barra ||
                                            'CODE128' }}</span></td>
                                    <td class="bg-white text-center py-1">
                                        <svg [id]="'barcode-' + cb.codigo_barra"></svg>
                                    </td>
                                    <td>{{ cb.unidad_medida?.nombre }}</td>
                                    <td class="text-center">
                                        <i *ngIf="cb.es_principal" class="fas fa-check-circle text-success"></i>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-danger btn-sm py-0 px-2"
                                            (click)="eliminarCodigo(cb)">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrarFormulario()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" (click)="guardar()">
                    <i class="fas fa-save me-2"></i>
                    {{ isEditing ? 'Actualizar' : 'Guardar' }}
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade" [class.show]="showForm" *ngIf="showForm"></div>