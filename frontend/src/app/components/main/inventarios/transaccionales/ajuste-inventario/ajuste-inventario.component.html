<div class="container-fluid py-3 fade-in">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0 fw-bold text-dark">
            <i class="fas fa-clipboard-check text-primary me-2"></i>
            Ajuste de Inventario
        </h5>
        <div class="d-flex">
            <button class="btn btn-sm btn-success me-2" (click)="nuevo()" [disabled]="enEdicion">
                <i class="fas fa-plus me-1"></i> Nuevo
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" (click)="limpiarFormulario()" [disabled]="!enEdicion">
                <i class="fas fa-times me-1"></i> Cancelar
            </button>
            <button class="btn btn-sm btn-primary" (click)="guardar()" [disabled]="!enEdicion">
                <i class="fas fa-save me-1"></i> Guardar Ajuste
            </button>
        </div>
    </div>

    <!-- Cabecera del Ajuste -->
    <div class="card p-3 mb-3 bg-light border-0 shadow-sm">
        <div class="row g-2">
            <!-- Fila 1 -->
            <div class="col-md-3">
                <label class="form-label small mb-0 fw-bold text-muted">Sucursal</label>
                <select #sucursalInput id="txtSucursal" appNextOnEnter class="form-select form-select-sm"
                    [(ngModel)]="nuevoAjuste.id_sucursal" (change)="onSucursalChange()" [disabled]="!enEdicion">
                    <option *ngFor="let s of sucursales" [ngValue]="s.id_sucursal">{{ s.nombre }}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-0 fw-bold text-muted">Depósito</label>
                <select appNextOnEnter class="form-select form-select-sm" [(ngModel)]="nuevoAjuste.id_deposito"
                    [disabled]="!enEdicion">
                    <option *ngFor="let d of depositos" [ngValue]="d.id_deposito">{{ d.nombre }}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 fw-bold text-muted">Moneda</label>
                <select appNextOnEnter class="form-select form-select-sm" [(ngModel)]="nuevoAjuste.id_moneda"
                    (change)="onMonedaFechaChange()" [disabled]="!enEdicion">
                    <option *ngFor="let m of monedas" [ngValue]="m.id_moneda">{{ m.nombre }}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 fw-bold text-muted">Tasas</label>
                <input type="text" class="form-control form-control-sm text-end"
                    [value]="nuevoAjuste.tasa_cambio | number:'1.0-2'" readonly disabled>
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 fw-bold text-muted">Tipo Ajuste</label>
                <select appNextOnEnter class="form-select form-select-sm" [(ngModel)]="nuevoAjuste.tipo_ajuste"
                    [disabled]="!enEdicion">
                    <option value="POSITIVO">Positivo (+)</option>
                    <option value="NEGATIVO">Negativo (-)</option>
                </select>
            </div>

            <!-- Fila 2 -->
            <div class="col-md-3">
                <label class="form-label small mb-0 fw-bold text-muted">Motivo</label>
                <select appNextOnEnter class="form-select form-select-sm" [(ngModel)]="nuevoAjuste.id_motivo_ajuste"
                    [disabled]="!enEdicion">
                    <option [ngValue]="0">Seleccione motivo...</option>
                    <option *ngFor="let m of motivos" [ngValue]="m.id_motivo_ajuste_inventario">{{ m.nombre }}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 fw-bold text-muted">Nro. Comprobante</label>
                <input appNextOnEnter type="number" class="form-control form-control-sm"
                    [(ngModel)]="nuevoAjuste.numero_comprobante" [disabled]="!enEdicion">
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 fw-bold text-muted">Fecha</label>
                <input appNextOnEnter type="date" class="form-control form-control-sm"
                    [(ngModel)]="nuevoAjuste.fecha_documento" (change)="onMonedaFechaChange()" [disabled]="!enEdicion">
            </div>
            <div class="col-md-5">
                <label class="form-label small mb-0 fw-bold text-muted">Observación</label>
                <input appNextOnEnter type="text" class="form-control form-control-sm"
                    [(ngModel)]="nuevoAjuste.observacion" placeholder="Observaciones del ajuste..."
                    [disabled]="!enEdicion">
            </div>
        </div>
    </div>
    <hr class="text-muted opacity-25">

    <div class="row align-items-end mb-3">

        <div class="col-12 col-md-2 position-relative">
            <label class="form-label small mb-0 text-muted">Búsqueda</label>
            <input type="text" class="form-control form-control-sm fw-bold" id="txtArticulo"
                [(ngModel)]="txtBusquedaArticulo" (input)="onBusquedaInput()" (keydown)="onBusquedaKeydown($event)"
                (focus)="$event.target.select()" (blur)="mostrarSugerencias = false" placeholder="Escáner / Código..."
                [disabled]="!enEdicion" autocomplete="off">

            <!-- Sugerencias -->
            <ul class="dropdown-menu w-100 show shadow-sm" *ngIf="mostrarSugerencias"
                style="max-height: 300px; overflow-y: auto; top: 100%; z-index: 1050;">
                <li *ngFor="let s of sugerencias; let i = index">
                    <button class="dropdown-item small py-1" type="button" [class.active]="i === indiceSugerencia"
                        (mousedown)="$event.preventDefault(); seleccionarArticulo(s)">
                        <div class="fw-bold">{{ s.codigo_alfanumerico }}</div>
                        <div class="text-truncate">{{ s.nombre }}</div>
                    </button>
                </li>
            </ul>
        </div>
        <div class="col-12 col-md-2">
            <label class="form-label small mb-0 text-muted">Artículo</label>
            <input type="text" class="form-control form-control-sm bg-light"
                [value]="articuloSeleccionado?.nombre || ''" readonly disabled>
        </div>

        <div class="col-12 col-md-2">
            <label class="form-label small mb-0 text-muted">Cantidad</label>
            <input id="txtCantidad" appNextOnEnter type="number" class="form-control form-control-sm text-end"
                [(ngModel)]="detalleActual.cantidad" (focus)="$event.target.select()" min="1" [disabled]="!enEdicion">
        </div>

        <div class="col-12 col-md-2">
            <label class="form-label small mb-0 text-muted">Costo Unit.</label>
            <input type="number" class="form-control form-control-sm text-end" [(ngModel)]="detalleActual.costo_ml"
                (focus)="$event.target.select()" (keydown.enter)="$event.preventDefault(); agregarItem()"
                [disabled]="!enEdicion">
        </div>

        <div class="col-12 col-md-2">
            <label class="form-label small mb-0 text-muted">Subtotal</label>
            <input type="text" class="form-control form-control-sm text-end bg-light"
                [value]="(detalleActual.cantidad * (detalleActual.costo_ml || 0)) | number:'1.' + decimals + '-' + decimals"
                readonly>
        </div>

        <div class="col-12 col-md-2">
            <button class="btn btn-success btn-sm w-100" (click)="agregarItem()" title="Agregar (Enter)"
                [disabled]="!enEdicion">
                <i class="fas fa-plus"></i> Agregar
            </button>
        </div>
    </div>

    ---

    <div class="card-body p-0 mt-3 border rounded">
        <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
            <table class="table table-sm table-hover table-bordered mb-0 align-middle">
                <thead class="table-light sticky-top">
                    <tr>
                        <th class="text-center" style="width:40px;">#</th>
                        <th>Artículo</th>
                        <th class="text-end" style="width:100px;">Cant.</th>
                        <th class="text-end" style="width:120px;">Costo Unit.</th>
                        <th class="text-end" style="width:120px;">Subtotal</th>
                        <th class="text-center" style="width:50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngIf="nuevoAjuste.detalle.length===0">
                        <td colspan="6" class="text-center text-muted py-5 small">
                            <i class="fas fa-box-open fa-2x mb-2 opacity-50"></i><br>
                            Agregue artículos al detalle
                        </td>
                    </tr>
                    <tr *ngFor="let item of nuevoAjuste.detalle; let i = index">
                        <td class="text-center small text-muted">{{ i+1 }}</td>
                        <td class="small fw-semibold">{{ item.articulo?.codigo_alfanumerico }} - {{
                            item.articulo?.nombre }}</td>
                        <td class="text-end small">{{ item.cantidad }}</td>
                        <td class="text-end small">{{ item.costo_ml | number:'1.' + decimals + '-' + decimals }}</td>
                        <td class="text-end small fw-bold">{{ (item.cantidad * (item.costo_ml || 0)) |
                            number:'1.' + decimals + '-' + decimals }}
                        </td>
                        <td class="text-center">
                            <button class="btn btn-outline-danger btn-sm py-0 px-1 border-0" (click)="eliminarItem(i)"
                                [disabled]="!enEdicion">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card-footer bg-white border-top py-2">
        <div class="row align-items-center">
            <div class="col-md-8 text-muted small">
                Items: <strong>{{ nuevoAjuste.detalle.length }}</strong>
            </div>
            <div class="col-md-4">
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded border">
                    <span class="fw-bold text-dark">TOTAL AJUSTE:</span>
                    <span class="fw-bold fs-5 text-primary">{{ calcularTotalNuevoAjuste() | number:'1.' + decimals + '-'
                        + decimals }}</span>
                </div>
            </div>
        </div>
    </div>
</div>